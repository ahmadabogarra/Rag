{% extends 'base.html' %}

{% block title %}{{ document.name }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1>
            <i class="fas fa-file-alt me-2"></i>{{ document.name }}
        </h1>
        <p class="text-muted">
            <strong>Last updated:</strong> {{ document.updated_at.strftime('%Y-%m-%d %H:%M') }}
        </p>
    </div>
    <div class="col-md-4 text-md-end">
        <div class="btn-group">
            <a href="{{ url_for('document_edit', document_id=document.id) }}" class="btn btn-warning">
                <i class="fas fa-edit me-1"></i>Edit Document
            </a>
            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteDocumentModal">
                <i class="fas fa-trash me-1"></i>Delete
            </button>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Document Information</h5>
                <button id="sync-embeddings" class="btn btn-sm btn-outline-info" data-document-id="{{ document.id }}">
                    <i class="fas fa-sync me-1"></i>Sync Embeddings
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Metadata</h6>
                        {% if metadata %}
                            <ul class="list-group">
                                {% for meta in metadata %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <strong>{{ meta.key }}</strong>
                                        <span>{{ meta.value }}</span>
                                    </li>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p class="text-muted">No metadata</p>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        <h6>Document Details</h6>
                        <ul class="list-group">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <strong>ID</strong>
                                <span class="text-muted">{{ document.id }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <strong>MIME Type</strong>
                                <span>{{ document.mime_type }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <strong>Created</strong>
                                <span>{{ document.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <strong>Chunks</strong>
                                <span>{{ chunks|length }}</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="document-tabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="content-tab" data-bs-toggle="tab" data-bs-target="#content" 
                                type="button" role="tab" aria-controls="content" aria-selected="true">
                            Full Content
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="chunks-tab" data-bs-toggle="tab" data-bs-target="#chunks" 
                                type="button" role="tab" aria-controls="chunks" aria-selected="false">
                            Chunks ({{ chunks|length }})
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="document-tabs-content">
                    <div class="tab-pane fade show active" id="content" role="tabpanel" aria-labelledby="content-tab">
                        <pre class="document-content p-3 bg-dark text-light rounded">{{ document.content }}</pre>
                    </div>
                    <div class="tab-pane fade" id="chunks" role="tabpanel" aria-labelledby="chunks-tab">
                        {% if chunks %}
                            <div class="accordion" id="chunksAccordion">
                                {% for chunk in chunks %}
                                    <div class="accordion-item">
                                        <h2 class="accordion-header" id="chunk-heading-{{ loop.index }}">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                                    data-bs-target="#chunk-collapse-{{ loop.index }}" aria-expanded="false" 
                                                    aria-controls="chunk-collapse-{{ loop.index }}">
                                                Chunk #{{ chunk.chunk_index + 1 }} (Pos: {{ chunk.start_pos }}-{{ chunk.end_pos }})
                                            </button>
                                        </h2>
                                        <div id="chunk-collapse-{{ loop.index }}" class="accordion-collapse collapse" 
                                             aria-labelledby="chunk-heading-{{ loop.index }}" data-bs-parent="#chunksAccordion">
                                            <div class="accordion-body">
                                                <pre class="chunk-content p-2 bg-dark text-light rounded">{{ chunk.content }}</pre>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <p class="text-muted">No chunks found for this document.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Search Similar Documents Card -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Search Similar Documents</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('search_page') }}" method="get">
                    <input type="hidden" name="query" value="{{ document.name }}">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="model-select" class="form-label">Embedding Model:</label>
                            <select class="form-select" id="model-select" name="model_id">
                                <option value="">Default</option>
                                {% for model in active_models %}
                                    <option value="{{ model.id }}">{{ model.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="top-k" class="form-label">Results Count:</label>
                            <input type="number" class="form-control" id="top-k" name="top_k" value="5" min="1" max="20">
                        </div>
                        <div class="col-md-3">
                            <label for="min-score" class="form-label">Minimum Score:</label>
                            <input type="number" class="form-control" id="min-score" name="min_score" value="0.5" min="0" max="1" step="0.1">
                        </div>
                        <div class="col-md-2 d-flex align-items-end">
                            <button type="submit" class="btn btn-info w-100">
                                <i class="fas fa-search me-1"></i>Find Similar
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Delete Document Modal -->
<div class="modal fade" id="deleteDocumentModal" tabindex="-1" aria-labelledby="deleteDocumentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteDocumentModalLabel">Confirm Deletion</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the document <strong>{{ document.name }}</strong>?</p>
                <p class="text-danger">This action cannot be undone!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form action="{{ url_for('document_delete', document_id=document.id) }}" method="post">
                    <button type="submit" class="btn btn-danger">Delete Document</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.document-content, .chunk-content {
    white-space: pre-wrap;
    overflow-x: auto;
    border-radius: 4px;
    font-family: monospace;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Sync embeddings button handling
    const syncButton = document.getElementById('sync-embeddings');
    if (syncButton) {
        syncButton.addEventListener('click', function() {
            const documentId = this.dataset.documentId;
            
            // Disable button and show loading state
            this.disabled = true;
            const originalText = this.innerHTML;
            this.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Syncing...';
            
            // Make API request to sync embeddings
            fetch(`/api/documents/${documentId}/sync`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({})
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                // Create alert for success
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle me-1"></i>${data.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                // Add alert to the page
                const cardBody = syncButton.closest('.card').querySelector('.card-body');
                cardBody.prepend(alertDiv);
                
                // Auto-dismiss after 5 seconds
                setTimeout(() => {
                    const bsAlert = new bootstrap.Alert(alertDiv);
                    bsAlert.close();
                }, 5000);
            })
            .catch(error => {
                console.error('Error syncing embeddings:', error);
                
                // Create alert for error
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
                alertDiv.innerHTML = `
                    <i class="fas fa-exclamation-circle me-1"></i>Error syncing embeddings: ${error.message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                
                // Add alert to the page
                const cardBody = syncButton.closest('.card').querySelector('.card-body');
                cardBody.prepend(alertDiv);
            })
            .finally(() => {
                // Re-enable button and restore original text
                this.disabled = false;
                this.innerHTML = originalText;
            });
        });
    }
});
</script>
{% endblock %}
